<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<title>可愛いものクラブ</title>
<style>
  body {
    margin: 0;
    font-family: sans-serif;
    height: 100vh;
    overflow: hidden;
    touch-action: none;
  }

  #titleScreen, #game, #endScreen {
    position: absolute;
    top: 0; left: 0;
    width: 100%; height: 100%;
    display: none;
    flex-direction: column;
  }

  #titleScreen {
    display: flex;
    align-items: center;
    justify-content: center;
    background: #333;
    color: white;
    text-shadow: 1px 1px 3px #000;
    flex-direction: column;
  }
  #titleLogo { width:60%; margin-top:20%; margin-bottom:auto; }
  #startBtn {
    margin-top: auto;
    margin-bottom: 20%;
    padding: 15px 30px;
    font-size: 20px;
    background: #ffb6c1;
    border: none;
    color: white;
    cursor: pointer;
    border-radius: 10px;
    transition: background 0.3s ease;
  }
  #startBtn:hover { background: #ff1493; }

  #countdown {
    position:absolute;
    top:50%; left:50%;
    transform:translate(-50%,-50%);
    font-size:80px;
    font-weight:bold;
    display:none;
    color:#fff;
    text-shadow:2px 2px 5px #000;
  }

  #header {
    display:flex;
    justify-content:space-between;
    align-items:center;
    padding:8px 16px;
    font-size:18px;
    font-weight:bold;
    background:#ffe0b2;
    flex-shrink:0;
    z-index:10;
  }

  #customers {
    overflow: visible;
    display: flex;
    justify-content: space-around;
    flex-grow: 1;
  }

  .customer-slot {
    width: 45%;
    height: 45%;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .customer {
    width: 100%;
    height: auto;
    position: relative;
    background-size: contain;
    background-repeat: no-repeat;
    background-position: center;
    overflow: visible;
  }

  .bubble {
    position: absolute;
    bottom: 100%;
    left: 50%;
    transform: translateX(-50%) translateY(-10px);
    background: #fff;
    border: 1px solid #333;
    padding: 12px 14px;
    border-radius: 10px;
    font-size: 18px;
    display: flex;
    gap: 10px;
    z-index: 2;
    align-items: center;
  }
  .bubble img { width: 64px; height: 64px; object-fit: contain; }

  #items {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 10px;
    padding: 12px;
    background: #ffd;
    z-index: 5;
  }

  .item {
    height: 84px;
    background: #eee;
    border: 2px solid #333;
    cursor: grab;
    text-align: center;
    user-select: none;
    display: flex;
    align-items: center;
    justify-content: center;
    touch-action: none;
  }
  .item img {
    width: 80px;
    height: 80px;
    object-fit: contain;
    display: block;
    pointer-events: none;
  }

  #endScreen {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: flex-start;
    background:#fff;
    color:#333;
    font-weight:bold;
    text-shadow:none;
  }
  #endHeader {
    position:absolute;
    top:10px; left:10px;
    display:flex;
    flex-direction:column;
    gap:5px;
    font-size:20px;
    z-index:5;
  }
  #clearImage { max-width:60%; margin-top:80px; }
  #restartBtn {
    margin-top:auto;
    margin-bottom:30px;
    padding:15px 30px;
    font-size:20px;
    background:#ff7043;
    border:none;
    color:white;
    cursor:pointer;
  }

  #feverCutIn {
    position:absolute;
    top:0; left:0;
    width:100%; height:100%;
    display:none;
    justify-content:center;
    align-items:center;
    background:rgba(255,255,255,0.6);
    z-index:10;
  }
  #feverCutIn img { max-width:80%; }

  #feverBackground {
    position:absolute;
    top:0; left:0; width:100%; height:100%;
    background:rgba(255,255,0,0.2);
    opacity:0;
    z-index:1;
    pointer-events:none;
  }
</style>
</head>
<body>

<div id="titleScreen">
  <img src="images/titlelogo.PNG" alt="ミニカフェゲーム" id="titleLogo">
  <button id="startBtn">ゲームスタート</button>
</div>

<div id="countdown">3</div>

<div id="game">
  <div id="header">
    <div>⏱ <span id="timer">90</span>s</div>
    <div>⭐ <span id="score">0000</span></div>
  </div>
  <div id="customers">
    <div class="customer-slot" data-slot="0"></div>
    <div class="customer-slot" data-slot="1"></div>
  </div>
  <div id="items"></div>
  <div id="feverBackground"></div>
  <div id="feverCutIn">
    <img src="images/cutin.PNG" alt="FEVER!">
  </div>
</div>

<div id="endScreen">
  <div id="endHeader">
    <div id="rank">ランク: -</div>
    <div id="finalScore">あなたのスコア: 0</div>
  </div>
  <img id="clearImage" src="" alt="クリアイラスト">
  <button id="restartBtn">もう一度</button>
</div>

<script>
let timeLeft=90, score=0, missCount=0, timerInterval, gameInterval, feverTime=false;
let touchDragItem=null, touchDragEl=null;
let activeCharacters=[];

const items = [
  { id:"A-1", img:"images/item_A-1.PNG", imgObj:null },
  { id:"A-2", img:"images/item_A-2.PNG", imgObj:null },
  { id:"A-3", img:"images/item_A-3.PNG", imgObj:null }
];

const slotImages = [
  {normal:"images/kyaku1.PNG", happy:"images/kyaku1_happy.PNG", sad:"images/kyaku1_sad.PNG"},
  {normal:"images/kyaku2.PNG", happy:"images/kyaku2_happy.PNG", sad:"images/kyaku2_sad.PNG"},
  {normal:"images/kyaku3.PNG", happy:"images/kyaku3_happy.PNG", sad:"images/kyaku3_sad.PNG"},
  {normal:"images/kyaku4.PNG", happy:"images/kyaku4_happy.PNG", sad:"images/kyaku4_sad.PNG"},
];

const titleScreen=document.getElementById("titleScreen");
const countdownEl=document.getElementById("countdown");
const gameEl=document.getElementById("game");
const endScreen=document.getElementById("endScreen");
const scoreEl=document.getElementById("score");
const timerEl=document.getElementById("timer");
const feverBg=document.getElementById("feverBackground");

function showScreen(id){
  titleScreen.style.display="none";
  gameEl.style.display="none";
  endScreen.style.display="none";
  if(id) document.getElementById(id).style.display="flex";
}

document.getElementById("startBtn").addEventListener("click", startCountdown);
document.getElementById("restartBtn").addEventListener("click", resetGame);

function startCountdown(){
  showScreen(null);
  countdownEl.style.display="block";
  let count=3;
  countdownEl.textContent=count;
  const interval=setInterval(()=>{
    count--;
    if(count>0) countdownEl.textContent=count;
    else { clearInterval(interval); countdownEl.style.display="none"; startGame(); }
  },1000);
}

function addScore(p){
  score += feverTime ? p*2 : p;
  scoreEl.textContent=String(score).padStart(4,'0');
}

function startGame(){
  showScreen("game");
  timeLeft=90; score=0; missCount=0; feverTime=false;
  feverBg.style.opacity=0;
  scoreEl.textContent=String(score).padStart(4,'0');
  timerEl.textContent=timeLeft;
  activeCharacters=[];

  const itemsDiv=document.getElementById("items");
  itemsDiv.innerHTML="";
  items.forEach(it=>{
    const d=document.createElement("div");
    d.className="item";
    d.dataset.id=it.id;
    const img=document.createElement("img");
    img.src=it.img; img.alt=it.id;
    d.appendChild(img);

    d.addEventListener("touchstart", e=>{
      e.preventDefault();
      touchDragItem=it.id;
      const touch=e.touches[0];
      touchDragEl=img.cloneNode(true);
      touchDragEl.style.position="fixed";
      touchDragEl.style.pointerEvents="none";
      touchDragEl.style.width=img.offsetWidth+"px";
      touchDragEl.style.height=img.offsetHeight+"px";
      touchDragEl.style.zIndex=1000;
      document.body.appendChild(touchDragEl);
      touchDragEl.style.left=touch.clientX-img.offsetWidth/2+"px";
      touchDragEl.style.top=touch.clientY-img.offsetHeight/2+"px";
    });

    d.addEventListener("touchmove", e=>{
      if(!touchDragEl) return;
      const touch=e.touches[0];
      touchDragEl.style.left=touch.clientX-touchDragEl.offsetWidth/2+"px";
      touchDragEl.style.top=touch.clientY-touchDragEl.offsetHeight/2+"px";
    });

    d.addEventListener("touchend", e=>{
      if(!touchDragEl) return;
      const touch=e.changedTouches[0];
      const elem=document.elementFromPoint(touch.clientX, touch.clientY);
      const slotEl=elem.closest('.customer-slot');
      if(slotEl) handleDrop(slotEl, touchDragItem);
      document.body.removeChild(touchDragEl);
      touchDragEl=null; touchDragItem=null;
    });

    itemsDiv.appendChild(d);
  });

  timerInterval=setInterval(()=>{
    timeLeft--; timerEl.textContent=timeLeft;
    checkFeverTime();
    if(timeLeft<=0) endGame();
  },1000);

  gameInterval=setInterval(spawnCustomer, 1500);
}

const allCustomerIndices=[0,1];
const allCharacterIndices=[0,1,2,3];

function spawnCustomer(){
  if(timeLeft<=0) return;
  const currentCustomers=document.querySelectorAll('.customer');
  if(currentCustomers.length>=2) return;

  const availableChars=allCharacterIndices.filter(i=>!activeCharacters.includes(i));
  if(availableChars.length===0) return;
  const charIndex=availableChars[Math.floor(Math.random()*availableChars.length)];

  const availableSlots=allCustomerIndices.filter(i=>!document.querySelector(`.customer-slot[data-slot="${i}"] .customer`));
  if(availableSlots.length===0) return;
  const slotIndex=availableSlots[Math.floor(Math.random()*availableSlots.length)];

  activeCharacters.push(charIndex);

  const slot=document.querySelector(`.customer-slot[data-slot="${slotIndex}"]`);
  const c=document.createElement('div');
  c.className='customer';
  c.style.backgroundImage=`url('${slotImages[charIndex].normal}')`;
  c.dataset.charIndex=charIndex;

  let orderCount=1;
  if(timeLeft<=60) orderCount=2;
  if(timeLeft<=30) orderCount=3;

  const order=[];
  while(order.length<orderCount){
    const pickObj=items[Math.floor(Math.random()*items.length)];
    if(!order.find(o=>o.id===pickObj.id)) order.push(pickObj);
  }

  const bubble=document.createElement('div');
  bubble.className='bubble';
  updateBubble(bubble, order);
  c.dataset.order=JSON.stringify(order.map(o=>o.id));
  c.dataset.slotIndex=slotIndex;
  c.appendChild(bubble);
  slot.appendChild(c);

  c.leaveTimer=setTimeout(()=>{
    if(slot.contains(c)){
      score=Math.max(0,score-20);
      missCount++;
      scoreEl.textContent=String(score).padStart(4,'0');
      c.style.backgroundImage=`url('${slotImages[charIndex].sad}')`;
      setTimeout(()=>{
        if(slot.contains(c)) slot.removeChild(c);
        activeCharacters=activeCharacters.filter(i=>i!==charIndex);
      },500);
    }
  },15000);
}

function updateBubble(bubbleEl, orderObjs){
  bubbleEl.innerHTML="";
  orderObjs.forEach(it=>{
    const img=document.createElement("img");
    img.src=it.img; img.alt=it.id;
    bubbleEl.appendChild(img);
  });
}

function handleDrop(slotEl, droppedId){
  const cust=slotEl.querySelector('.customer');
  if(!cust) return;
  const orderIds=JSON.parse(cust.dataset.order);
  const idx=orderIds.findIndex(x=>x===droppedId);
  const charIndex=parseInt(cust.dataset.charIndex);
  if(idx!==-1){
    orderIds.splice(idx,1);
    const remainingObjs=orderIds.map(id=>items.find(it=>it.id===id));
    updateBubble(cust.querySelector('.bubble'), remainingObjs);
    cust.dataset.order=JSON.stringify(orderIds);
    if(orderIds.length===0){
      addScore(50);
      if(cust.leaveTimer) clearTimeout(cust.leaveTimer);
      cust.style.backgroundImage=`url('${slotImages[charIndex].happy}')`;
      setTimeout(()=>{
        if(slotEl.contains(cust)) slotEl.removeChild(cust);
        activeCharacters=activeCharacters.filter(i=>i!==charIndex);
      },500);
    }
  } else {
    score=Math.max(0,score-10); missCount++;
    scoreEl.textContent=String(score).padStart(4,'0');
    if(cust.leaveTimer) clearTimeout(cust.leaveTimer);
    cust.style.backgroundImage=`url('${slotImages[charIndex].sad}')`;
    setTimeout(()=>{
      if(slotEl.contains(cust)) slotEl.removeChild(cust);
      activeCharacters=activeCharacters.filter(i=>i!==charIndex);
    },500);
  }
}

function checkFeverTime(){
  if(timeLeft===30 && missCount===0 && !feverTime){
    feverTime=true;
    const feverCutIn=document.getElementById("feverCutIn");
    feverCutIn.style.display="flex";
    feverBg.style.opacity=0.5;
    setTimeout(()=>{feverCutIn.style.display="none";},1000);
  }
}

function endGame(){
  clearInterval(timerInterval);
  clearInterval(gameInterval);
  document.querySelectorAll('.customer').forEach(c=>{ 
    const parent=c.parentNode; if(parent) parent.removeChild(c);
  });
  showScreen("endScreen");
  document.getElementById("finalScore").textContent=`あなたのスコア: ${score}`;
}

function resetGame(){ showScreen("titleScreen"); }
</script>

</body>
</html>
